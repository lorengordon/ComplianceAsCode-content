# platform = multi_platform_ol
# reboot = false
# strategy = enable
# complexity = low
# disruption = low
- (xccdf-var var_secure_mode_insmod)

- name: Configure the secure_mode_insmod SELinux Boolean - Ensure libsemanage-python
    installed
  ansible.builtin.package:
    name: libsemanage-python
    state: present
  when:
  - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
  - not ( lookup("env", "container") == "bwrap-osbuild" )
  tags:
  - enable_strategy
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - sebool_secure_mode_insmod

- name: Configure the secure_mode_insmod SELinux Boolean - Set SELinux boolean secure_mode_insmod
    accordingly
  ansible.posix.seboolean:
    name: secure_mode_insmod
    state: '{{ var_secure_mode_insmod }}'
    persistent: true
  when:
  - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
  - not ( lookup("env", "container") == "bwrap-osbuild" )
  tags:
  - enable_strategy
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - sebool_secure_mode_insmod

- name: Configure the secure_mode_insmod SELinux Boolean - Add vfat to static kernel
    module list
  ansible.builtin.lineinfile:
    create: true
    dest: /etc/modules-load.d/vfat.conf
    regexp: ^\s*\bvfat\b
    line: vfat
  when:
  - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
  - not ( lookup("env", "container") == "bwrap-osbuild" )
  tags:
  - enable_strategy
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - sebool_secure_mode_insmod

- name: Configure the secure_mode_insmod SELinux Boolean - Regenerate initramfs
  ansible.builtin.command:
    cmd: dracut -f --regenerate-all
  when:
  - ansible_virtualization_type not in ["docker", "lxc", "openvz", "podman", "container"]
  - not ( lookup("env", "container") == "bwrap-osbuild" )
  tags:
  - enable_strategy
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - sebool_secure_mode_insmod

# platform = multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- (xccdf-var var_accounts_authorized_local_users_regex)

- name: Read /etc/shadow
  getent:
    database: shadow
  tags:
  - CCE-83195-8
  - DISA-STIG-SLES-12-010630
  - NIST-800-53-CM-6(b)
  - NIST-800-53-CM-6.1(iv)
  - accounts_authorized_local_users
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - restrict_strategy

- name: Remove unauthorized accounts
  user:
    name: '{{ item.key }}'
    force: true
    state: absent
  when: item.key is not regex(var_accounts_authorized_local_users_regex)
  with_dict: '{{ getent_shadow }}'
  tags:
  - CCE-83195-8
  - DISA-STIG-SLES-12-010630
  - NIST-800-53-CM-6(b)
  - NIST-800-53-CM-6.1(iv)
  - accounts_authorized_local_users
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - restrict_strategy


<def-group>
  <definition class="compliance" id="nftables_rules_permanent" version="1">
    <metadata>
        <title>Ensure nftables rules are permanent</title>
        
    <affected family="unix">
    <platform>SUSE Linux Enterprise 15</platform>
    </affected>
        <description>Make sure that there is permanent nftables configuration file used
    to save and re-apply rules on reboot</description>
    </metadata>
    <criteria operator="AND">
      <criterion test_ref="test_nftables_rules_permanent_file"
                 comment="Check the existence of top level nftables configuration file" />

      <criterion test_ref="test_nftables_rules_permanent_include_bridge"
                 comment="Check the contents of configuration file for bridge family"/>

      <criterion test_ref="test_nftables_rules_permanent_include_arp"
                 comment="Check the contents of configuration file for arp family"/>

      <criterion test_ref="test_nftables_rules_permanent_include_inet"
                 comment="Check the contents of configuration file for inet family"/>

    </criteria>
  </definition>
  <ind:textfilecontent54_test id="test_nftables_rules_permanent_file"
  comment="Check top level configuration file is named as expected"
  check="all" check_existence="all_exist" version="1">
    <ind:object object_ref="object_nftables_rules_permanent_file" />
  </ind:textfilecontent54_test>

  <ind:textfilecontent54_test id="test_nftables_rules_permanent_include_bridge"
  comment="Check top level configuration file includes expected bridge family clauses"
  check="at least one" version="1">
    <ind:object object_ref="object_nftables_rules_permanent_file" />
    <ind:state state_ref="state_nftables_rules_permanent_bridge_contents" />
  </ind:textfilecontent54_test>

  <ind:textfilecontent54_state id="state_nftables_rules_permanent_bridge_contents" version="1">
    <ind:subexpression datatype="string" operation="pattern match" var_check="at least one"
                       var_ref="var_nftables_rules_permanent_required_bridge_files"/>
  </ind:textfilecontent54_state>

  <local_variable id="var_nftables_rules_permanent_required_bridge_files" version="1"
                  comment="Pattern to match all required families files" datatype="string">
    <literal_component>/etc/nftables/bridge-filter</literal_component>
  </local_variable>

  <ind:textfilecontent54_test id="test_nftables_rules_permanent_include_arp"
  comment="Check top level configuration file includes expected arp family clauses"
  check="at least one" version="1">
    <ind:object object_ref="object_nftables_rules_permanent_file" />
    <ind:state state_ref="state_nftables_rules_permanent_arp_contents" />
  </ind:textfilecontent54_test>

  <ind:textfilecontent54_state id="state_nftables_rules_permanent_arp_contents" version="1">
    <ind:subexpression datatype="string" operation="pattern match" var_check="at least one"
                       var_ref="var_nftables_rules_permanent_required_arp_files"/>
  </ind:textfilecontent54_state>

  <local_variable id="var_nftables_rules_permanent_required_arp_files" version="1"
                  comment="Pattern to match all required families files" datatype="string">
    <literal_component>/etc/nftables/arp-filter</literal_component>
  </local_variable>

  <ind:textfilecontent54_test id="test_nftables_rules_permanent_include_inet"
  comment="Check top level configuration file includes expected inet family clauses"
  check="at least one" version="1">
    <ind:object object_ref="object_nftables_rules_permanent_file" />
    <ind:state state_ref="state_nftables_rules_permanent_inet_contents" />
  </ind:textfilecontent54_test>

  <ind:textfilecontent54_state id="state_nftables_rules_permanent_inet_contents" version="1">
    <ind:subexpression datatype="string" operation="pattern match" var_check="at least one"
                       var_ref="var_nftables_rules_permanent_required_inet_files"/>
  </ind:textfilecontent54_state>

  <local_variable id="var_nftables_rules_permanent_required_inet_files" version="1"
                  comment="Pattern to match all required families files" datatype="string">
    <literal_component>/etc/nftables/inet-filter</literal_component>
  </local_variable>

  <ind:textfilecontent54_object id="object_nftables_rules_permanent_file" version="1">
    <ind:filepath operation="equals" var_ref="var_nftable_master_config_file"/>
    <ind:pattern operation="pattern match">^[\s]*include[\s]+\"([^\s]+)"$</ind:pattern>
    <ind:instance datatype="int" operation="greater than or equal">1</ind:instance>
  </ind:textfilecontent54_object>
  <external_variable comment="file path" datatype="string"
                     id="var_nftable_master_config_file" version="1"/>
  <local_variable id="var_nftables_rules_permanent_families_config_paths" datatype="string" version="1"
    comment="File paths of all needed families part of the permanent configuration">
    <object_component item_field="subexpression" object_ref="object_nftables_rules_permanent_file" />
  </local_variable>
</def-group>
# platform = multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: Find soft links /etc/pam.d/
  find:
    paths: /etc/pam.d
    file_type: link
    patterns: common-.*
    use_regex: true
  register: find_pam_soft_links_result
  tags:
  - CCE-85641-9
  - DISA-STIG-SLES-15-040220
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - pam_disable_automatic_configuration
  - restrict_strategy

- name: Remove soft links in /etc/pam.d/
  shell: |
    set -o pipefail
    target=$(readlink -f "{{ item.path }}")
    cp -p --remove-destination "$target" "{{ item.path }}"
  with_items: '{{ find_pam_soft_links_result.files }}'
  tags:
  - CCE-85641-9
  - DISA-STIG-SLES-15-040220
  - low_complexity
  - low_disruption
  - medium_severity
  - no_reboot_needed
  - pam_disable_automatic_configuration
  - restrict_strategy

# platform = multi_platform_all
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low


- name: "Find sshd_config included files"
  shell: |-
    included_files=$(grep -oP "^\s*(?i)include.*" /etc/ssh/sshd_config | sed -e 's/Include\s*//i' | sed -e 's|^[^/]|/etc/ssh/&|')
    [[ -n $included_files ]] && ls $included_files || true
  register: sshd_config_included_files

- name: "Comment conf from included files"
  replace:
    path: '{{ item }}'
    regexp: '^(\s*X11Forwarding.*)$'
    replace: '# \1'
  loop: "{{ sshd_config_included_files.stdout_lines }}"




- name: "Enable Encrypted X11 Forwarding"
  block:
    - name: "Check for duplicate values"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: no
        regexp: '(?i)^\s*X11Forwarding\s+'
        state: 'absent'
      check_mode: yes
      changed_when: no
      register: 'dupes'
    - name: "Deduplicate values from /etc/ssh/sshd_config"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: no
        regexp: '(?i)^\s*X11Forwarding\s+'
        state: 'absent'
      when: 'dupes.found is defined and dupes.found > 1'
    - name: "Insert correct line to /etc/ssh/sshd_config"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: yes
        regexp: '(?i)^\s*X11Forwarding\s+'
        line: 'X11Forwarding yes'
        state: present
        insertbefore: '^[#\s]*Match'
        validate: '/usr/sbin/sshd -t -f %s'
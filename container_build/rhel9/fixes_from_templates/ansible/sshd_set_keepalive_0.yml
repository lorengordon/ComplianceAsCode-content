# platform = multi_platform_all
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low


- name: 'Set SSH Client Alive Count Max to zero'
  block:
    - name: "Deduplicate values from /etc/ssh/sshd_config"
      lineinfile:
        path: '/etc/ssh/sshd_config'
        create: no
        regexp: '(?i)^\s*{{ "ClientAliveCountMax"| regex_escape }}\s+'
        state: 'absent'
    
    - name: 'Check if /etc/ssh/sshd_config.d exists'
      stat:
        path: '/etc/ssh/sshd_config.d'
      register: '_etc_ssh_sshd_config_d_exists'
    
    - name: 'Check if the parameter ClientAliveCountMax is present in /etc/ssh/sshd_config.d'
      find:
        paths: '/etc/ssh/sshd_config.d'
        recurse: 'yes'
        follow: 'no'
        contains: '(?i)^\s*{{ "ClientAliveCountMax"| regex_escape }}\s+'
      register: '_etc_ssh_sshd_config_d_has_parameter'
      when: '_etc_ssh_sshd_config_d_exists.stat.isdir is defined and _etc_ssh_sshd_config_d_exists.stat.isdir'
    - name: "Remove parameter from files in /etc/ssh/sshd_config.d"
      lineinfile:
        path: '{{ item.path }}'
        create: no
        regexp: '(?i)^\s*{{ "ClientAliveCountMax"| regex_escape }}\s+'
        state: 'absent'
      with_items: '{{ _etc_ssh_sshd_config_d_has_parameter.files }}'
      when: '_etc_ssh_sshd_config_d_has_parameter.matched'
    - name: "Insert correct line to /etc/ssh/sshd_config.d/00-complianceascode-hardening.conf"
      lineinfile:
        path: '/etc/ssh/sshd_config.d/00-complianceascode-hardening.conf'
        create: yes
        regexp: '(?i)^\s*{{ "ClientAliveCountMax"| regex_escape }}\s+'
        line: 'ClientAliveCountMax 0'
        state: present
        insertbefore: '^[#\s]*Match'
        validate: '/usr/sbin/sshd -t -f %s'
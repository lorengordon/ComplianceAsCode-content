# platform = multi_platform_sle
# reboot = false
# strategy = unknown
# complexity = low
# disruption = medium
- name: Gather the package facts
  package_facts:
    manager: auto
  tags:
  - CCE-83003-4
  - DISA-STIG-SLES-12-010020
  - NIST-800-53-AC-8 a
  - NIST-800-53-AC-8 b
  - NIST-800-53-AC-8.1 (ii)
  - NIST-800-53-AC-8.1 (iii)
  - gui_login_dod_acknowledgement
  - low_complexity
  - medium_disruption
  - medium_severity
  - no_reboot_needed
  - unknown_strategy

- name: Validate /etc/gdm/Xsession is executable
  stat:
    path: /etc/gdm/Xsession
  register: file_stat
  when: '"gdm" in ansible_facts.packages'
  tags:
  - CCE-83003-4
  - DISA-STIG-SLES-12-010020
  - NIST-800-53-AC-8 a
  - NIST-800-53-AC-8 b
  - NIST-800-53-AC-8.1 (ii)
  - NIST-800-53-AC-8.1 (iii)
  - gui_login_dod_acknowledgement
  - low_complexity
  - medium_disruption
  - medium_severity
  - no_reboot_needed
  - unknown_strategy

- name: Validate /etc/gdm/Xsession is a shell script
  lineinfile:
    dest: /etc/gdm/Xsession
    line: '#!/bin/sh'
  check_mode: true
  register: presence
  when: '"gdm" in ansible_facts.packages'
  tags:
  - CCE-83003-4
  - DISA-STIG-SLES-12-010020
  - NIST-800-53-AC-8 a
  - NIST-800-53-AC-8 b
  - NIST-800-53-AC-8.1 (ii)
  - NIST-800-53-AC-8.1 (iii)
  - gui_login_dod_acknowledgement
  - low_complexity
  - medium_disruption
  - medium_severity
  - no_reboot_needed
  - unknown_strategy

- name: Update file /etc/gdm/Xsession
  blockinfile:
    path: /etc/gdm/Xsession
    block: |
      if ! zenity --text-info \
       --title "Consent" \
       --filename=/etc/gdm/banner \
       --no-markup \
       --checkbox="Accept." 10 10; then
        sleep 1;
        exit 1;
      fi
    insertafter: '#!/bin/sh'
    state: present
  when:
  - '"gdm" in ansible_facts.packages'
  - not presence.changed | bool
  - file_stat.stat.executable | bool
  tags:
  - CCE-83003-4
  - DISA-STIG-SLES-12-010020
  - NIST-800-53-AC-8 a
  - NIST-800-53-AC-8 b
  - NIST-800-53-AC-8.1 (ii)
  - NIST-800-53-AC-8.1 (iii)
  - gui_login_dod_acknowledgement
  - low_complexity
  - medium_disruption
  - medium_severity
  - no_reboot_needed
  - unknown_strategy

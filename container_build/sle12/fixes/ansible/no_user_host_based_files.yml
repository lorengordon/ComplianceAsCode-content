# platform = multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: Find local mount points
  shell: |
    set -o pipefail
    df --local | awk '{print $6}' | grep -v Mounted | grep -v '^/dev' || true
  register: local_mount_points
  tags:
  - CCE-83021-6
  - DISA-STIG-SLES-12-010400
  - high_severity
  - low_complexity
  - low_disruption
  - no_reboot_needed
  - no_user_host_based_files
  - restrict_strategy

- name: Detect the .shosts files on the system
  find:
    paths: '{{ item }}'
    recurse: true
    patterns:
    - .shosts
    hidden: true
    file_type: file
  check_mode: false
  with_items: '{{ local_mount_points.stdout_lines }}'
  register: shosts_locations
  tags:
  - CCE-83021-6
  - DISA-STIG-SLES-12-010400
  - high_severity
  - low_complexity
  - low_disruption
  - no_reboot_needed
  - no_user_host_based_files
  - restrict_strategy

- name: Remove .shosts Files
  file:
    path: '{{ item.path }}'
    state: absent
  with_items: '{{ shosts_locations.results | map(attribute=''files'') | list }}'
  when: shosts_locations is success
  tags:
  - CCE-83021-6
  - DISA-STIG-SLES-12-010400
  - high_severity
  - low_complexity
  - low_disruption
  - no_reboot_needed
  - no_user_host_based_files
  - restrict_strategy

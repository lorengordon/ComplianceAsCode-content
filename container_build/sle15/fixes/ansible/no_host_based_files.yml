# platform = multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: Find local mount points
  shell: |
    set -o pipefail
    df --local | awk '{print $6}' | grep -v Mounted | grep -v '^/dev' || true
  register: local_mount_points
  tags:
  - CCE-85622-9
  - DISA-STIG-SLES-15-040030
  - high_severity
  - low_complexity
  - low_disruption
  - no_host_based_files
  - no_reboot_needed
  - restrict_strategy

- name: Detect the shosts.equiv files on the system
  find:
    paths: '{{ item }}'
    recurse: true
    patterns:
    - shosts.equiv
    file_type: file
  check_mode: false
  with_items: '{{ local_mount_points.stdout_lines }}'
  register: shosts_equiv_locations
  tags:
  - CCE-85622-9
  - DISA-STIG-SLES-15-040030
  - high_severity
  - low_complexity
  - low_disruption
  - no_host_based_files
  - no_reboot_needed
  - restrict_strategy

- name: Remove shosts.equiv Files
  file:
    path: '{{ item.path }}'
    state: absent
  with_items: '{{ shosts_equiv_locations.results | map(attribute=''files'') | list
    }}'
  when: shosts_equiv_locations is success
  tags:
  - CCE-85622-9
  - DISA-STIG-SLES-15-040030
  - high_severity
  - low_complexity
  - low_disruption
  - no_host_based_files
  - no_reboot_needed
  - restrict_strategy
